generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  relationMode = "prisma"
}

// Enums
enum IssueStatus {
  BRAINSTORMING
  CATEGORIZE
  VOTE
  SELECT
  CLOSE
}

enum VoteType {
  AGREE
  DISAGREE
}

enum IssueRole {
  OWNER
  MEMBER
}

// Models
model User {
  id            String    @id @default(uuid()) @db.Char(36)
  name          String?   @db.VarChar(30)
  email         String?   @unique @db.VarChar(255)
  emailVerified DateTime? @map("email_verified")
  image         String?   @map("avatar_url") @db.VarChar(2048)
  displayName   String?   @map("display_name") @db.VarChar(30)
  provider      String?   @db.VarChar(30)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  accounts Account[]
  sessions Session[]

  // Relations
  ownedProjects  Project[]
  projectMembers ProjectMember[]
  issueMembers   IssueMember[]
  ideas          Idea[]
  comments       Comment[]
  votes          Vote[]

  @@map("users")
}

model Account {
  id                       String  @id @default(uuid()) @db.Char(36)
  userId                   String  @map("user_id") @db.Char(36)
  type                     String
  provider                 String
  providerAccountId        String  @map("provider_account_id")
  refresh_token            String? @db.Text
  access_token             String? @db.Text
  expires_at               Int?
  refresh_token_expires_in Int?
  token_type               String?
  scope                    String?
  id_token                 String? @db.Text
  session_state            String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid()) @db.Char(36)
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id") @db.Char(36)
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Project {
  id          String    @id @default(uuid()) @db.Char(36)
  ownerId     String?   @map("owner_id") @db.Char(36)
  title       String    @db.VarChar(255)
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  owner          User?           @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  projectMembers ProjectMember[]
  topics         Topic[]
  invitations    ProjectInvitation[]

  @@index([ownerId])
  @@map("projects")
}

model ProjectMember {
  id        String    @id @default(uuid()) @db.Char(36)
  userId    String    @map("user_id") @db.Char(36)
  projectId String    @map("project_id") @db.Char(36)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId, deletedAt])
  @@index([userId])
  @@index([projectId])
  @@map("project_members")
}

model ProjectInvitation {
  id            String   @id @default(uuid())
  token         String   @unique 
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId     String

  expiresAt     DateTime
  createdAt     DateTime @default(now())
  
  invitees     ProjectInvitee[]    

  @@map("project_invitaions")
}

model ProjectInvitee {
  id           String            @id @default(uuid())
  
  email        String            
  isAccepted   Boolean           @default(false)
  acceptedAt   DateTime?         
  
  invitationId String
  invitation   ProjectInvitation @relation(fields: [invitationId], references: [id], onDelete: Cascade)

  @@unique([invitationId, email])
  @@index([email])
  @@map("project_invitees")
}

model Topic {
  id        String    @id @default(uuid()) @db.Char(36)
  projectId String    @map("project_id") @db.Char(36)
  title     String    @db.VarChar(255)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  issues  Issue[]

  @@index([projectId])
  @@map("topics")
}

model Issue {
  id        String      @id @default(uuid()) @db.Char(36)
  topicId   String?     @map("topic_id") @db.Char(36)
  title     String      @db.VarChar(255)
  status    IssueStatus @default(BRAINSTORMING)
  closedAt  DateTime?   @map("closed_at")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  deletedAt DateTime?   @map("deleted_at")

  // Relations
  topic                 Topic?            @relation(fields: [topicId], references: [id], onDelete: Cascade)
  issueMembers          IssueMember[]
  connectionsAsSource   IssueConnection[] @relation("SourceIssue")
  connectionsAsTarget   IssueConnection[] @relation("TargetIssue")
  categories            Category[]
  ideas                 Idea[]
  reports               Report[]
  issueNode             IssueNode?

  @@index([topicId])
  @@index([status])
  @@map("issues")
}

model IssueMember {
  id        String    @id @default(uuid()) @db.Char(36)
  issueId   String    @map("issue_id") @db.Char(36)
  userId    String    @map("user_id") @db.Char(36)
  nickname  String    @db.VarChar(30)
  role      IssueRole @default(MEMBER)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([issueId, userId]) // 유저 중복 방지
  @@index([userId])
  @@index([issueId])
  @@map("issue_members")
}

model IssueNode {
  id        String    @id @default(uuid()) @db.Char(36)
  issueId   String    @unique @map("issue_id") @db.Char(36)
  positionX Float     @map("position_x") @db.Float
  positionY Float     @map("position_y") @db.Float
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@index([issueId])
  @@map("issue_nodes")
}

model IssueConnection {
  id             String    @id @default(uuid()) @db.Char(36)
  sourceIssueId  String    @map("source_issue_id") @db.Char(36)
  targetIssueId  String    @map("target_issue_id") @db.Char(36)
  sourceHandle   String?   @map("source_handle") @db.VarChar(20)
  targetHandle   String?   @map("target_handle") @db.VarChar(20)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  // Relations
  sourceIssue Issue @relation("SourceIssue", fields: [sourceIssueId], references: [id], onDelete: Cascade)
  targetIssue Issue @relation("TargetIssue", fields: [targetIssueId], references: [id], onDelete: Cascade)

  @@unique([sourceIssueId, targetIssueId, deletedAt])
  @@index([targetIssueId])
  @@map("issue_connections")
}

model Category {
  id        String    @id @default(uuid()) @db.Char(36)
  issueId   String    @map("issue_id") @db.Char(36)
  title     String    @db.VarChar(255)
  positionX Float?    @map("position_x") @db.Float
  positionY Float?    @map("position_y") @db.Float
  width     Float?    @db.Float
  height    Float?    @db.Float
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  issue Issue  @relation(fields: [issueId], references: [id], onDelete: Cascade)
  ideas Idea[]

  @@index([issueId])
  @@map("categories")
}

model Idea {
  id            String    @id @default(uuid()) @db.Char(36)
  issueId       String    @map("issue_id") @db.Char(36)
  userId        String?   @map("user_id") @db.Char(36)
  categoryId    String?   @map("category_id") @db.Char(36)
  content       String    @db.Text
  positionX     Float?    @map("position_x") @db.Float
  positionY     Float?    @map("position_y") @db.Float
  agreeCount    Int       @default(0)
  disagreeCount Int       @default(0)
  isSelected    Boolean   @default(false) @map("is_selected")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  issue    Issue     @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  comments Comment[]
  votes    Vote[]
  reports  Report[]

  @@index([issueId])
  @@index([userId])
  @@index([categoryId])
  @@map("ideas")
}

model Comment {
  id        String    @id @default(uuid()) @db.Char(36)
  ideaId    String    @map("idea_id") @db.Char(36)
  userId    String?   @map("user_id") @db.Char(36)
  content   String    @db.Text
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  idea Idea @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([ideaId])
  @@index([userId])
  @@map("comments")
}

model Vote {
  id        String    @id @default(uuid()) @db.Char(36)
  ideaId    String    @map("idea_id") @db.Char(36)
  userId    String?   @map("user_id") @db.Char(36)
  type      VoteType
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  idea Idea @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@unique([ideaId, userId, deletedAt])
  @@index([ideaId])
  @@index([userId])
  @@map("votes")
}

model Report {
  id             String    @id @default(uuid()) @db.Char(36)
  issueId        String    @map("issue_id") @db.Char(36)
  selectedIdeaId String?   @map("selected_idea_id") @db.Char(36)
  memo           String?   @db.Text
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  // Relations
  issue        Issue       @relation(fields: [issueId], references: [id], onDelete: Cascade)
  selectedIdea Idea?       @relation(fields: [selectedIdeaId], references: [id], onDelete: SetNull)
  wordClouds   WordCloud[]

  @@index([issueId])
  @@index([selectedIdeaId])
  @@map("reports")
}

model WordCloud {
  id        String    @id @default(uuid()) @db.Char(36)
  reportId  String    @map("report_id") @db.Char(36)
  word      String    @db.VarChar(255)
  count     Int?      @db.Int
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@unique([reportId, word, deletedAt])
  @@index([reportId])
  @@map("word_clouds")
}
